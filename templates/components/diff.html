<table class="diff">
    <caption>
        {% if diff.a %}{{ diff.a.path }}{% else %}(New File){% endif %}
        {% if diff.a.path != diff.b.path %}
            =>
            {% if diff.b %}{{ diff.b.path }}{% else %}(Deleted){% endif %}
        {% endif %}
    </caption>
    {% for change in diff.changes %}
        {% if change.type == '@' %}
            <tr class="break">
                <td colspan="3">{{ change.text }}</td>
            </tr>
        {% else %}
            <tr id="{{ review.pk }}_{{ forloop.parentloop.counter0 }}_{% if change.type != '+' %}{{ change.line_a }}{% else %}0{% endif %}_{% if change.type != '-' %}{{ change.line_b }}{% else %}0{% endif %}"
                class="{% if change.type == '+' %}add{% endif %}{% if change.type == '-' %}del{% endif %}">
                <td class="number">{% if change.type != '+' %}{{ change.line_a }}{% endif %}</td>
                <td class="number">{% if change.type != '-' %}{{ change.line_b }}{% endif %}</td>
                <td class="text">{{ change.text }}</td>
            </tr>

            {% if review %}
                {% for comment in review.comment_set.all %}
                    {% if change.type == '+' and change.line_b == comment.line_b or change.type == '-' and change.line_a == comment.line_a or change.line_a == comment.line_a and change.line_b == comment.line_b %}
                    <tr class="annotation">
                        <td colspan="3">
                            {% include "components/comment.html" %}
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endif %}
    {% endfor %}
</table>
